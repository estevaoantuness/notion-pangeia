"""
M√≥dulo de Humaniza√ß√£o de Mensagens.

Implementa o guia de humaniza√ß√£o para tornar as intera√ß√µes
mais naturais, emp√°ticas e profissionais-casuais.

Baseado no guia JSON com regras de:
- Linguagem: pt-BR profissional-casual
- Emojis: max 2 por mensagem, sem repeti√ß√£o adjacente
- Varia√ß√µes: m√∫ltiplas op√ß√µes para cada tipo de mensagem
"""

import random
from datetime import datetime
from typing import Optional, Dict, List
import pytz

from config.settings import settings


class MessageHumanizer:
    """
    Humaniza mensagens do bot seguindo guia de tom e estilo.

    Caracter√≠sticas:
    - Tom profissional-casual
    - M√°ximo 2 emojis por mensagem
    - Varia√ß√µes aleat√≥rias para evitar repeti√ß√£o
    - Contexto temporal (hora do dia, dia da semana)
    """

    # Paleta de emojis permitida
    EMOJI_PALETTE = ["‚úÖ","‚è≥","üöß","üìã","üîó","üí™","üéâ","üëÄ","‚ö†Ô∏è","‚≠ê","‚òÄÔ∏è","üåô"]

    # Cat√°logo de mensagens
    CATALOG = {
        "ajuda": [
            "Guia r√°pido: \"minhas tarefas\", \"progresso\", \"feito N\", \"andamento N\", \"bloqueada N - motivo\". Quer ver sua lista agora?",
            "Posso fazer: listar tarefas, marcar conclu√≠da (\"feito N\"), iniciar (\"andamento N\") ou registrar bloqueio (\"bloqueada N - motivo\"). Come√ßamos pela lista?",
            "Comandos √∫teis: \"minhas tarefas\" | \"progresso\" | \"feito N\" | \"andamento N\" | \"bloqueada N - motivo\". Qual deseja usar?",
            "Para agir r√°pido: diga \"minhas tarefas\" para ver a numera√ß√£o; depois use \"feito N\" ou \"andamento N\". Precisa de exemplo?",
            "Dica: \"minhas tarefas\" mostra os n√∫meros; \"bloqueada N - motivo\" registra impedimento. Quer que eu envie sua lista?",
            "Tem d√∫vida? Use \"ajuda\" a qualquer momento. Ex.: concluir: \"feito 2\"; iniciar: \"andamento 3\"; listar: \"minhas tarefas\".",
            "Ferramentas do dia a dia: listar, concluir, iniciar, bloquear (com motivo) e ver progresso. Come√ßamos por qual?",
            "Para bloquear algo, lembre o motivo: \"bloqueada 4 - sem acesso\". Para concluir: \"feito 4\". Quer abrir a lista?"
        ],

        "listar_tarefas": [
            "{first_name}, aqui est√° sua lista de hoje (1..N). Use \"feito N\" para concluir ou \"andamento N\" para come√ßar. P√°gina completa: {link}",
            "Agenda do dia pronta. Numera√ß√£o 1..N para voc√™ agir. Concluir: \"feito N\" | Iniciar: \"andamento N\" | Bloquear: \"bloqueada N - motivo\". Ver tudo: {link}",
            "Estas s√£o suas tarefas de hoje. Fale \"feito {task_number}\" quando encerrar uma ou \"andamento {task_number}\" para iniciar. Detalhes no Notion: {link}",
            "Lista carregada. Se algo impedir, use \"bloqueada N - motivo\". Para conferir contextos, abra: {link}",
            "Suas tarefas est√£o numeradas para facilitar. Quer que eu destaque a pr√≥xima prioridade? Link da p√°gina: {link}",
            "Aqui est√° o panorama do dia. Quando concluir, diga \"feito N\". Se quiser ver tudo em tela cheia: {link}",
            "Listei suas tasks. Precisa reorganizar prioridades? Posso ajudar. Acesso completo: {link}",
            "Tudo pronto. Use os n√∫meros para atualizar r√°pido. Se preferir, abra a visualiza√ß√£o completa: {link}"
        ],

        "progresso": [
            "Progresso: {done}/{total} ({percent}%). Quer priorizar a pr√≥xima?",
            "{percent}% do dia entregue ({done}/{total}). Alguma pend√™ncia que eu deva marcar?",
            "Voc√™ concluiu {done} de {total}. Mantemos o ritmo? Posso sugerir a pr√≥xima.",
            "Status atual: {done}/{total} conclu√≠das. Precisa de ajuda com algo espec√≠fico?",
            "{percent}% feito. Se algo travou, posso registrar um bloqueio para visibilidade.",
            "Parcial do dia: {done}/{total}. Quer ver a lista numerada de novo?",
            "Boa evolu√ß√£o: {percent}%. Preferir focar nas urgentes ou nas r√°pidas agora?",
            "Resumo: {done} conclu√≠das de {total}. Quer abrir o link geral? {link}"
        ],

        "concluir": [
            "‚úÖ Pronto! Marquei \"{task_title}\" como conclu√≠da. Prossigo com a pr√≥xima?",
            "Feito! \"{task_title}\" conclu√≠da. Quer ver sua lista atualizada?",
            "Boa! \"{task_title}\" j√° est√° fechada. Quer que eu inicie outra?",
            "Conclu√≠da: \"{task_title}\". Precisa registrar algum detalhe antes de seguir?",
            "Finalizei \"{task_title}\". Quer priorizar a pr√≥xima tarefa?",
            "Registro feito: \"{task_title}\" conclu√≠da. Deseja abrir o painel completo?",
            "Conferido e conclu√≠do: \"{task_title}\". Avan√ßamos?",
            "Tudo certo com \"{task_title}\". Posso listar a pr√≥xima?"
        ],

        "andamento": [
            "‚è≥ Coloquei \"{task_title}\" em andamento. Aviso se precisar de algo.",
            "\"{task_title}\" agora est√° em andamento. Quer definir a pr√≥xima etapa?",
            "Status atualizado para em andamento: \"{task_title}\". Sigo acompanhando.",
            "Iniciei \"{task_title}\". Quando finalizar, diga \"feito {task_number}\".",
            "Movi \"{task_title}\" para andamento. Deseja registrar um objetivo r√°pido?",
            "Come√ßamos \"{task_title}\". Precisa de checklist?",
            "Atualizado: \"{task_title}\" em andamento. Quer ver a lista numerada?",
            "Marquei como em andamento: \"{task_title}\". Pr√≥ximo passo definido?"
        ],

        "bloqueada": [
            "üöß \"{task_title}\" marcada como bloqueada. Motivo: \"{reason}\". Quer que eu notifique o time?",
            "Registrei o bloqueio em \"{task_title}\": \"{reason}\". Precisamos envolver algu√©m?",
            "Bloqueio anotado: \"{task_title}\" ‚Äî \"{reason}\". Posso registrar uma a√ß√£o de follow‚Äëup?",
            "\"{task_title}\" est√° bloqueada por: \"{reason}\". Deseja abrir um pedido de suporte?",
            "Status atualizado: bloqueada. \"{task_title}\" ‚Äî \"{reason}\". Quer priorizar outra enquanto isso?",
            "Bloqueio confirmado em \"{task_title}\". \"{reason}\". Sigo monitorando.",
            "Anotei o bloqueio: \"{task_title}\" (\"{reason}\"). Posso adicionar observa√ß√µes?",
            "Bloqueada por \"{reason}\": \"{task_title}\". Vamos redirecionar o foco por enquanto?"
        ],

        "erro_formato": [
            "Quase l√°. Use \"feito N\" (verbo antes do n√∫mero). Quer ver sua lista numerada?",
            "N√£o entendi o formato. Ex.: \"andamento 2\" ou \"bloqueada 3 - sem acesso\". Mostro a lista?",
            "Formato diferente do esperado. Tente: \"feito 2\". Posso enviar \"minhas tarefas\"?",
            "Para eu entender, mande assim: \"feito N\" ou \"andamento N\". Quer atualizar a numera√ß√£o?",
            "Preciso no padr√£o: \"bloqueada N - motivo\". Ex.: \"bloqueada 4 - aguardando aprova√ß√£o\". Mostro as tasks?",
            "N√£o consegui mapear. Diga \"minhas tarefas\" e depois use \"feito N\". Envio a lista?",
            "Vamos padronizar: \"feito 1\", \"andamento 1\", \"bloqueada 1 - motivo\". Quer a lista agora?",
            "Se preferir, eu relembro os n√∫meros com \"minhas tarefas\". Depois √© s√≥ mandar \"feito N\"."
        ],

        "indice_invalido": [
            "N√£o encontrei a tarefa {task_number}. Quer que eu envie \"minhas tarefas\" para confirmar a numera√ß√£o?",
            "√çndice {task_number} n√£o est√° na lista atual. Mostro a lista numerada?",
            "Esse n√∫mero n√£o bate com o mapeamento do dia. Deseja atualizar a lista?",
            "{task_number} n√£o consta na sua lista. Posso reenviar a numera√ß√£o 1..N?",
            "Parece fora do intervalo. Que tal eu mandar \"minhas tarefas\" de novo?",
            "N√£o localizei {task_number}. Atualizo a listagem para voc√™ decidir?",
            "N√∫mero inv√°lido no contexto atual. Quer ver o painel completo? {link}",
            "Esse √≠ndice n√£o est√° ativo hoje. Envio a lista para confirmar?"
        ],

        "sem_tarefas": [
            "Voc√™ n√£o tem tarefas hoje. Quer puxar algo do backlog?",
            "Sem itens na sua lista por enquanto. Posso sugerir prioridades?",
            "Nada por aqui agora. Quer abrir o board no Notion? {link}",
            "Lista vazia. Deseja que eu busque tarefas do projeto principal?",
            "Sem tarefas ativas. Prefere revisar pend√™ncias antigas?",
            "Nada agendado para hoje. Quer importar do backlog r√°pido?",
            "Dia livre por enquanto. Abro a p√°gina geral? {link}",
            "Sem tarefas. Posso criar um planejamento leve para hoje?"
        ],

        "onboarding": [
            "Boas‚Äëvindas! Posso listar suas tasks: diga \"minhas tarefas\". Para concluir algo: \"feito N\". Quer come√ßar pela lista?",
            "Oi! Para ver sua agenda: \"minhas tarefas\". Depois use \"feito N\" ou \"andamento N\". Envio a lista agora?",
            "Bem‚Äëvindo. Eu ajudo a agir r√°pido: \"minhas tarefas\" mostra os n√∫meros; \"feito N\" conclui; \"bloqueada N - motivo\" registra impedimento.",
            "Vamos nessa. Primeiro, \"minhas tarefas\"; depois voc√™ usa os n√∫meros: \"feito N\" ou \"andamento N\". Quer ver a numera√ß√£o?",
            "Conte comigo para organizar o dia. Diga \"minhas tarefas\" e eu te guio pelos pr√≥ximos passos."
        ]
    }

    # Sauda√ß√µes temporais
    SAUDACOES_TEMPORAIS = {
        "manha": [
            "Bom dia! ‚òÄÔ∏è Tudo pronto para come√ßar?",
            "Opa, bom dia! Caf√© tomado? Vamos organizar as prioridades.",
            "E a√≠, bom dia! Posso listar suas tarefas de hoje?",
            "Bom dia por aqui. Quer ver a agenda 1..N?",
            "Come√ßando o dia? Trago suas tasks agora."
        ],
        "tarde": [
            "Boa tarde! Como est√° o ritmo por a√≠?",
            "E a√≠! Boa tarde. Quer um check r√°pido de progresso?",
            "Ol√°! Boa tarde. Posso listar o que falta hoje?",
            "Seguimos! Boa tarde. Atualizo sua lista?",
            "Boa tarde, {first_name}. Foco na pr√≥xima entrega?"
        ],
        "noite": [
            "Boa noite! üåô Fechamos o dia com mais uma?",
            "Ol√°, boa noite. Quer registrar o que ficou conclu√≠do?",
            "E a√≠! Boa noite. Precisa marcar algo como bloqueado?",
            "Noite por aqui. Mostro a lista final do dia?",
            "Boa noite. Quer um resumo r√°pido de progresso?"
        ],
        "segunda": [
            "Segunda chegou. Bora come√ßar a semana com clareza!",
            "Nova semana, novas entregas. Quer ver as prioridades?",
            "Segunda‚Äëfeira: organizo sua lista para um bom in√≠cio?",
            "Vamos abrir a semana com foco. Posso listar suas tasks?",
            "Semana nova, energia nova. Quer priorizar as urgentes?"
        ],
        "sexta": [
            "Sextou! üéâ Vamos fechar a semana redondo?",
            "√öltimo g√°s da semana. Quer ver o que falta?",
            "Sexta √© dia de concluir. Mostro sua lista final?",
            "Fechamento de semana: priorizamos o essencial?",
            "Quase l√°. Quer um resumo do que resta hoje?"
        ],
        "fallback": [
            "Ol√°! Posso te ajudar a organizar as tarefas agora?",
            "Oi! Quer listar suas tarefas e decidir a pr√≥xima?",
            "Tudo bem por a√≠? Trago sua lista numerada?",
            "Vamos avan√ßar mais uma? Posso sugerir a pr√≥xima.",
            "Precisando de algo? Posso listar ou atualizar status."
        ]
    }

    # Perguntas de check-in
    CHECKINS = {
        "13h30": [
            "Planejamento r√°pido: o que entra hoje? Quais projetos e tasks? Objetivo em uma frase.",
            "Me diga: o que voc√™ precisa fazer hoje? Em quais projetos? Qual o objetivo principal?",
            "Liste as tasks de hoje e o porqu√™ de cada uma. Como pretende executar?",
            "Quais entregas entram hoje? Diga projeto, task e objetivo.",
            "Planejo com voc√™: tarefas do dia, projeto e resultado esperado.",
            "Resumo do plano: o que fazer, por qu√™ e como voc√™ vai atacar?"
        ],
        "15h30": [
            "Status agora: o que est√° fazendo? Algo mudou? Surgiu demanda nova?",
            "Como est√° a task atual? Quer registrar d√∫vidas ou bloqueios?",
            "Checkpoint: andamento atual, mudan√ßas desde cedo e poss√≠veis impedimentos.",
            "Qual √© a tarefa em foco agora? Teve alguma altera√ß√£o de rota?",
            "Seguimos bem? Atualize: o que faz agora e se h√° novidades.",
            "Quer registrar evolu√ß√£o desde a manh√£? Posso anotar mudan√ßas."
        ],
        "18h00": [
            "Fechamento: o que voc√™ entregou? Algum insight? Maior desafio e como resolveu?",
            "Encerrando o dia: entregas, aprendizados e desafios superados.",
            "Me conte o que saiu hoje, o que aprendeu e como resolveu o mais dif√≠cil.",
            "Resumo do dia: feitos, li√ß√µes e solu√ß√µes aplicadas.",
            "Quais foram as entregas de hoje e o maior aprendizado?",
            "Fechamos com o que foi entregue e os insights principais?"
        ],
        "22h00": [
            "Como foi o dia? Conseguiu entregar tudo que planejou?",
            "Quer registrar algo sobre o dia de hoje?",
            "Dia finalizado? Quer compartilhar como foi?",
            "Como est√° se sentindo com as entregas de hoje?",
            "Quer fazer um resumo r√°pido do dia?"
        ]
    }

    def __init__(self):
        """Inicializa o humanizador."""
        self.tz = pytz.timezone(settings.TIMEZONE)

    def get_message(
        self,
        message_type: str,
        placeholders: Optional[Dict[str, str]] = None
    ) -> str:
        """
        Retorna mensagem humanizada com varia√ß√£o.

        Args:
            message_type: Tipo de mensagem do cat√°logo
            placeholders: Dicion√°rio com valores para substituir

        Returns:
            Mensagem formatada
        """
        if message_type not in self.CATALOG:
            return f"Mensagem tipo '{message_type}' n√£o encontrada."

        # Escolhe varia√ß√£o aleat√≥ria
        message = random.choice(self.CATALOG[message_type])

        # Substitui placeholders se fornecidos
        if placeholders:
            for key, value in placeholders.items():
                placeholder = f"{{{key}}}"
                if placeholder in message:
                    message = message.replace(placeholder, str(value))

        return message

    def get_greeting(self, person_name: Optional[str] = None) -> str:
        """
        Retorna sauda√ß√£o contextual baseada em hora/dia.

        Args:
            person_name: Nome da pessoa (para personalizar)

        Returns:
            Sauda√ß√£o apropriada
        """
        now = datetime.now(self.tz)
        hour = now.hour
        weekday = now.weekday()

        # Prioridade para dia da semana especial
        if weekday == 0:  # Segunda
            greeting = random.choice(self.SAUDACOES_TEMPORAIS["segunda"])
        elif weekday == 4:  # Sexta
            greeting = random.choice(self.SAUDACOES_TEMPORAIS["sexta"])
        # Sen√£o, por per√≠odo do dia
        elif 5 <= hour < 12:
            greeting = random.choice(self.SAUDACOES_TEMPORAIS["manha"])
        elif 12 <= hour < 18:
            greeting = random.choice(self.SAUDACOES_TEMPORAIS["tarde"])
        elif 18 <= hour < 24:
            greeting = random.choice(self.SAUDACOES_TEMPORAIS["noite"])
        else:
            greeting = random.choice(self.SAUDACOES_TEMPORAIS["fallback"])

        # Personaliza com nome se fornecido
        if person_name and "{first_name}" in greeting:
            first_name = person_name.split()[0]
            greeting = greeting.replace("{first_name}", first_name)

        return greeting

    def get_checkin_question(self, hour_minute: str) -> str:
        """
        Retorna pergunta de check-in apropriada.

        Args:
            hour_minute: Hor√°rio no formato "HH:MM" (ex: "13:30")

        Returns:
            Pergunta de check-in
        """
        # Mapeia hor√°rios aproximados
        checkin_map = {
            "13:30": "13h30",
            "15:30": "15h30",
            "18:00": "18h00",
            "22:00": "22h00",
        }

        checkin_key = checkin_map.get(hour_minute)

        if checkin_key and checkin_key in self.CHECKINS:
            return random.choice(self.CHECKINS[checkin_key])

        return "Como est√£o as coisas por a√≠? Quer compartilhar um update?"

    def personalize(self, message: str, person_name: str) -> str:
        """
        Personaliza mensagem com nome da pessoa.

        Args:
            message: Mensagem base
            person_name: Nome completo da pessoa

        Returns:
            Mensagem personalizada
        """
        first_name = person_name.split()[0]

        # Substitui todos os placeholders de nome
        message = message.replace("{first_name}", first_name)
        message = message.replace("{nome}", first_name)

        return message


# Inst√¢ncia global
_humanizer_instance = None


def get_humanizer() -> MessageHumanizer:
    """
    Retorna inst√¢ncia singleton do humanizador.

    Returns:
        MessageHumanizer: Inst√¢ncia global
    """
    global _humanizer_instance

    if _humanizer_instance is None:
        _humanizer_instance = MessageHumanizer()

    return _humanizer_instance

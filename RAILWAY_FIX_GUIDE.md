# üîß Guia de Corre√ß√£o: OpenAI Client None no Railway

## üêõ Problema Identificado

O bot falha ao processar comandos com o erro:
```
AttributeError: 'NoneType' object has no attribute 'chat'
```

**Causa:** OpenAI client retorna `None` porque `OPENAI_API_KEY` n√£o est√° configurada ou est√° vazia no Railway.

---

## ‚úÖ Solu√ß√£o

### 1. Verificar Estado Atual

Acesse o endpoint de debug:
```bash
curl https://botpangeia-production.up.railway.app/debug
```

Verifique se `openai_client.is_none` est√° como `true` - isso confirma o problema.

### 2. Configurar OPENAI_API_KEY no Railway

**Passo a passo:**

1. Acesse o [Railway Dashboard](https://railway.app)
2. Entre no projeto `talented-expression`
3. Selecione o servi√ßo `botpangeia`
4. V√° em **Variables**
5. Procure por `OPENAI_API_KEY`

**Verifique:**
- ‚úÖ A chave deve ter **164 caracteres**
- ‚úÖ Deve come√ßar com `sk-proj-`
- ‚ùå N√ÉO pode estar truncada
- ‚ùå N√ÉO pode ter espa√ßos ou quebras de linha

**Configurar chave:**
```bash
# Use a chave OpenAI do projeto (164 caracteres)
# Formato: sk-proj-XXXXX...
railway variables set OPENAI_API_KEY="[SUA_CHAVE_AQUI]"
```

### 3. For√ßar Redeploy

Ap√≥s atualizar a vari√°vel:
1. V√° em **Deployments**
2. Clique em **Deploy** no √∫ltimo commit
3. Aguarde ~2-3 minutos

### 4. Verificar Corre√ß√£o

Teste novamente o endpoint de debug:
```bash
curl https://botpangeia-production.up.railway.app/debug
```

**Resposta esperada:**
```json
{
  "openai_client": {
    "is_none": false,
    "type": "<class 'openai.OpenAI'>"
  },
  "environment_variables": {
    "OPENAI_API_KEY": {
      "present": true,
      "length": 164,
      "prefix": "sk-proj-JJ"
    }
  }
}
```

### 5. Testar Bot

Envie uma mensagem de teste via WhatsApp:
```
Usu√°rio: "oi"
Bot: "E a√≠! Bora ver suas tasks?"

Usu√°rio: "bora"
Bot: [deve listar as tasks corretamente]
```

---

## üîç Melhorias Implementadas Neste Commit

1. **Logs aprimorados** em `config/openai_config.py`:
   - Agora mostra claramente quando a API key n√£o est√° configurada
   - Exibe o comprimento da chave quando encontrada

2. **Verifica√ß√£o adicional** em `src/agents/conversational_agent.py`:
   - Checa se o client √© `None` antes de tentar usar
   - Retorna erro descritivo se n√£o estiver configurado

3. **Endpoint /debug melhorado**:
   - Mostra status de todas vari√°veis de ambiente cr√≠ticas
   - Exibe se o OpenAI client foi inicializado corretamente
   - √ötil para diagnosticar problemas de configura√ß√£o

---

## üìã Checklist de Deploy

- [ ] Atualizar `OPENAI_API_KEY` no Railway (164 caracteres)
- [ ] Verificar outras vari√°veis cr√≠ticas (NOTION_TOKEN, etc)
- [ ] Fazer commit das mudan√ßas
- [ ] Push para GitHub
- [ ] Railway faz deploy autom√°tico
- [ ] Acessar `/debug` para confirmar
- [ ] Testar bot via WhatsApp

---

## üö® Alternativa: Deploy no Render

Se preferir migrar do Railway para Render:

1. **Criar novo Web Service no Render**
2. **Conectar ao reposit√≥rio GitHub**
3. **Configurar vari√°veis de ambiente** (todas as mesmas do Railway)
4. **Build Command:** `pip install -r requirements.txt`
5. **Start Command:** `gunicorn -w 4 -b 0.0.0.0:$PORT src.webhook.app:app`

---

## üìû Contato

Se o problema persistir ap√≥s seguir este guia, verifique os logs do Railway em **Deployments > Logs**.

**√öltima atualiza√ß√£o:** 31/10/2025
